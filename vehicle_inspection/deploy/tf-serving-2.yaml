apiVersion: apps/v1
kind: Deployment
metadata:
  name: tf-serving-deployment
  labels:
    app: tf-serving
spec:
  replicas: 2
  selector:
    matchLabels:
      app: tf-serving
  template:
    metadata:
      labels:
        app: tf-serving
    spec:
      # Init container copies the model out of the model image into the shared emptyDir volume
      initContainers:
        - name: load-model
          image: car-damage-model:1                # <-- the image you built above
          imagePullPolicy: IfNotPresent
          command: ["sh", "-c", "mkdir -p /models && cp -r /export/* /models/"]
          volumeMounts:
            - name: model-store
              mountPath: /models

      containers:
        - name: tf-serving
          image: tensorflow/serving:2.13.0
          imagePullPolicy: IfNotPresent
          args:
            - "--model_name=car_damage_model"
            - "--model_base_path=/models/car_damage_model"
          ports:
            - name: rest
              containerPort: 8501
            - name: grpc
              containerPort: 8500
          volumeMounts:
            - name: model-store
              mountPath: /models
          resources:
            requests:
              cpu: "1"
              memory: "2Gi"
            limits:
              cpu: "2"
              memory: "4Gi"

      # Shared in-pod storage for the model
      volumes:
        - name: model-store
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: tf-serving-service
spec:
  selector:
    app: tf-serving
  ports:
    - name: http
      port: 8501
      targetPort: 8501
    - name: grpc
      port: 8500
      targetPort: 8500
  type: ClusterIP
